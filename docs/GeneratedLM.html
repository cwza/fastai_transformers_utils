---

title: GeneratedLM

keywords: fastai
sidebar: home_sidebar

summary: "Language Model or Decoder with Generate function"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_GeneratedLM.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<p style="color: red;">
The default version of TensorFlow in Colab will soon switch to TensorFlow 2.x.<br>
We recommend you <a href="https://www.tensorflow.org/guide/migrate" target="_blank">upgrade</a> now 
or ensure your notebook will continue to use TensorFlow 1.x via the <code>%tensorflow_version 1.x</code> magic:
<a href="https://colab.research.google.com/notebooks/tensorflow_version.ipynb" target="_blank">more info</a>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<p style="color: red;">
The default version of TensorFlow in Colab will soon switch to TensorFlow 2.x.<br>
We recommend you <a href="https://www.tensorflow.org/guide/migrate" target="_blank">upgrade</a> now 
or ensure your notebook will continue to use TensorFlow 1.x via the <code>%tensorflow_version 1.x</code> magic:
<a href="https://colab.research.google.com/notebooks/tensorflow_version.ipynb" target="_blank">more info</a>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FakeDecoder,-FakeLM-for-Test">FakeDecoder, FakeLM for Test<a class="anchor-link" href="#FakeDecoder,-FakeLM-for-Test">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">FakeDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; with memory not support past&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_vocab_size</span> <span class="o">=</span> <span class="n">tgt_vocab_size</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">momory</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        inputs: (tgt, memory)</span>
<span class="sd">            tgt: (b, tgt_seq_len)</span>
<span class="sd">            memory: (b, src_seq_len, embed_dim)</span>
<span class="sd">        returns: logits, others</span>
<span class="sd">            logits: (b, tgt_seq_len, tgt_vocab_size)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="o">*</span><span class="n">tgt</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_vocab_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="kc">None</span>
    
<span class="k">class</span> <span class="nc">FakeLM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; without memory support past &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_vocab_size</span> <span class="o">=</span> <span class="n">tgt_vocab_size</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        if past==None:</span>
<span class="sd">            inputs: (tgt)</span>
<span class="sd">                tgt: (b, tgt_seq_len)</span>
<span class="sd">            returns: logits, presents, others</span>
<span class="sd">                logits: (b, tgt_seq_len, tgt_vocab_size)</span>
<span class="sd">                presents: List of (2, b, ...)</span>
<span class="sd">        else:</span>
<span class="sd">            inputs: (tgt, past)</span>
<span class="sd">                tgt: (b, 1)   </span>
<span class="sd">                past: List of (2, bs, num_heads, tgt_seq_len-1, ..)</span>
<span class="sd">            returns: logits, presents, others</span>
<span class="sd">                logits: (b, tgt_seq_len, tgt_vocab_size)</span>
<span class="sd">                presents: List of (2, bs, num_heads, tgt_seq_len, ..)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tgt_seq_len</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_vocab_size</span><span class="p">))</span>
            <span class="n">presents</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">))]</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tgt_seq_len</span> <span class="o">=</span> <span class="n">past</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_vocab_size</span><span class="p">))</span>
            <span class="n">presents</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">))]</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">presents</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tgt_seq_len</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">tgt_vocab_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">past</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))]</span> <span class="o">*</span> <span class="mi">6</span>
<span class="n">pad_token_id</span><span class="o">=</span><span class="mi">0</span>
<span class="n">eos_token_id</span><span class="o">=</span><span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">1</span>
<span class="n">bos_token_id</span><span class="o">=</span><span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">decoder</span> <span class="o">=</span> <span class="n">FakeDecoder</span><span class="p">(</span><span class="n">tgt_vocab_size</span><span class="p">)</span>
<span class="n">lm</span> <span class="o">=</span> <span class="n">FakeLM</span><span class="p">(</span><span class="n">tgt_vocab_size</span><span class="p">)</span>

<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">decoder</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">memory</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="n">tgt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="n">tgt</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">past</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">past</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="GeneratedLM">GeneratedLM<a class="anchor-link" href="#GeneratedLM">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GeneratedLM" class="doc_header"><code>class</code> <code>GeneratedLM</code><a href="https://github.com/cwza/fastai_transformers_utils/tree/master/fastai_transformers_utils/generated_lm.py#L15" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GeneratedLM</code>(<strong><code>lm</code></strong>, <strong><code>vocab_size</code></strong>, <strong><code>support_past</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="_generate_no_beam_search">_generate_no_beam_search<a class="anchor-link" href="#_generate_no_beam_search">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span>
<span class="n">generate_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="n">pad_token_id</span><span class="p">,</span>
    <span class="n">eos_token_ids</span><span class="o">=</span><span class="p">[</span><span class="n">eos_token_id</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># With memory, Without past</span>
<span class="n">generated_decoder</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">bos_token_id</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_decoder</span><span class="o">.</span><span class="n">_generate_no_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">,</span> <span class="n">model_otherargs</span><span class="o">=</span><span class="p">[</span><span class="n">memory</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>

<span class="c1"># Without memory, With past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">_generate_no_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>

<span class="c1"># Without memory, Without past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">_generate_no_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="_generate_beam_search">_generate_beam_search<a class="anchor-link" href="#_generate_beam_search">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span>
<span class="n">generate_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="n">pad_token_id</span><span class="p">,</span>
    <span class="n">eos_token_ids</span><span class="o">=</span><span class="p">[</span><span class="n">eos_token_id</span><span class="p">],</span>
    <span class="n">length_penalty</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">vocab_size</span><span class="o">=</span><span class="n">tgt_vocab_size</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># With memory, Without past</span>
<span class="n">generated_decoder</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">bos_token_id</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_decoder</span><span class="o">.</span><span class="n">_generate_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">,</span> <span class="n">model_otherargs</span><span class="o">=</span><span class="p">[</span><span class="n">memory</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>

<span class="c1"># Without memory, With past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">_generate_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>

<span class="c1"># Without memory, Without past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">_generate_beam_search</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="generate">generate<a class="anchor-link" href="#generate">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generate" class="doc_header"><code>generate</code><a href="https://github.com/cwza/fastai_transformers_utils/tree/master/fastai_transformers_utils/generated_lm.py#L310" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generate</code>(<strong><code>tgt</code></strong>, <strong><code>max_length</code></strong>=<em><code>20</code></em>, <strong><code>do_sample</code></strong>=<em><code>False</code></em>, <strong><code>num_beams</code></strong>=<em><code>1</code></em>, <strong><code>temperature</code></strong>=<em><code>1.0</code></em>, <strong><code>top_k</code></strong>=<em><code>1</code></em>, <strong><code>top_p</code></strong>=<em><code>1.0</code></em>, <strong><code>repetition_penalty</code></strong>=<em><code>1</code></em>, <strong><code>pad_token_id</code></strong>=<em><code>None</code></em>, <strong><code>eos_token_ids</code></strong>=<em><code>None</code></em>, <strong><code>length_penalty</code></strong>=<em><code>1.0</code></em>, <strong><code>model_otherargs</code></strong>=<em><code>[]</code></em>, <strong><code>model_otherkwargs</code></strong>=<em><code>{}</code></em>)</p>
</blockquote>
<p>tgt: (b, tgt_seq_len)
model_otherargs: Other positional args that your model need. Maybe momory from encoder.
model_otherkwargs: Other keyword args that your model need. Maybe some masks.
returns: (b, (tgt_seq_len &lt;= ? &lt;= max_length))</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span>
<span class="n">generate_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="n">pad_token_id</span><span class="p">,</span>
    <span class="n">eos_token_ids</span><span class="o">=</span><span class="p">[</span><span class="n">eos_token_id</span><span class="p">],</span>
    <span class="n">length_penalty</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">generated_decoder</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">bos_token_id</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_decoder</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">,</span> <span class="n">model_otherargs</span><span class="o">=</span><span class="p">[</span><span class="n">memory</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>

<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>

<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span>
<span class="n">generate_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">top_p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="n">pad_token_id</span><span class="p">,</span>
    <span class="n">eos_token_ids</span><span class="o">=</span><span class="p">[</span><span class="n">eos_token_id</span><span class="p">],</span>
    <span class="n">length_penalty</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># With memory, Without past</span>
<span class="n">generated_decoder</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">bos_token_id</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_decoder</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">,</span> <span class="n">model_otherargs</span><span class="o">=</span><span class="p">[</span><span class="n">memory</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>

<span class="c1"># Without memory, With past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>

<span class="c1"># Without memory, Without past</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">,</span> <span class="n">support_past</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_length</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tgt_seq_len</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test">Test<a class="anchor-link" href="#Test">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test that with do_sample=False, GeneratedLM.generate should returns the same result as huggingface's PretrainedModel.generate</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># slow</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="k">import</span> <span class="n">AutoModelWithLMHead</span><span class="p">,</span> <span class="n">AutoTokenizer</span>
<span class="n">lm</span> <span class="o">=</span> <span class="n">AutoModelWithLMHead</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;distilgpt2&#39;</span><span class="p">)</span>
<span class="n">lm</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;distilgpt2&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># slow</span>
<span class="n">sentence</span> <span class="o">=</span> <span class="s1">&#39;The dog is a&#39;</span>
<span class="n">tgt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sentence</span><span class="p">)])</span>

<span class="n">generate_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">repetition_penalty</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">eos_token_ids</span><span class="o">=</span><span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">],</span>
    <span class="n">length_penalty</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">generated_lm</span> <span class="o">=</span> <span class="n">GeneratedLM</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">numeric_result</span> <span class="o">=</span> <span class="n">generated_lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">numeric_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">huggingface_numeric_result</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_args</span><span class="p">)</span>
<span class="n">huggingface_result</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">huggingface_numeric_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">huggingface_result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

